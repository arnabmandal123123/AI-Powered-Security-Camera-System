<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ESP32-CAM Security System - Human Detection</title>
    <!-- TensorFlow.js for AI Human Detection -->
    <script src="https://cdn.jsdelivr.net/npm/@tensorflow/tfjs@4.11.0"></script>
    <script src="https://cdn.jsdelivr.net/npm/@tensorflow-models/coco-ssd@2.2.3"></script>
    
    <style>
/* Smart Security System - Modern Dashboard Styles */

* {
    margin: 0;
    padding: 0;
    box-sizing: border-box;
}

:root {
    --primary-color: #667eea;
    --primary-light: #764ba2;
    --secondary-color: #48bb78;
    --danger-color: #fc5c65;
    --warning-color: #f7b731;
    --dark-bg: #0f0c29;
    --card-bg: rgba(30, 30, 60, 0.7);
    --text-primary: #ffffff;
    --text-secondary: #a0aec0;
    --border-color: rgba(255, 255, 255, 0.1);
    --shadow: 0 8px 32px rgba(0, 0, 0, 0.4);
    --glow: 0 0 20px rgba(102, 126, 234, 0.5);
    --text-light: #95a5a6;
    --text-dark: #2c3e50;
    --light-bg: #ecf0f1;
    --success-color: #2ecc71;
}

body {
    font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
    background: linear-gradient(135deg, #0f0c29 0%, #302b63 50%, #24243e 100%);
    color: var(--text-primary);
    min-height: 100vh;
    padding: 0;
    margin: 0;
    position: relative;
}

body::before {
    content: '';
    position: fixed;
    top: 0;
    left: 0;
    width: 100%;
    height: 100%;
    background: 
        radial-gradient(circle at 20% 50%, rgba(102, 126, 234, 0.1) 0%, transparent 50%),
        radial-gradient(circle at 80% 80%, rgba(118, 75, 162, 0.1) 0%, transparent 50%);
    pointer-events: none;
    z-index: 0;
}

.container {
    max-width: 1400px;
    margin: 0 auto;
    padding: 20px;
    position: relative;
    z-index: 1;
}

/* Header */
header {
    background: rgba(30, 30, 60, 0.5);
    backdrop-filter: blur(20px);
    -webkit-backdrop-filter: blur(20px);
    padding: 30px;
    border-radius: 20px;
    box-shadow: var(--shadow);
    margin-bottom: 30px;
    text-align: center;
    border: 1px solid var(--border-color);
}

header h1 {
    background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
    -webkit-background-clip: text;
    -webkit-text-fill-color: transparent;
    background-clip: text;
    font-size: 3em;
    margin-bottom: 10px;
    font-weight: 700;
    letter-spacing: -1px;
}

.subtitle {
    color: var(--text-secondary);
    font-size: 1.1em;
    margin-bottom: 20px;
}

.connection-status {
    display: inline-flex;
    align-items: center;
    gap: 10px;
    background: rgba(30, 30, 60, 0.6);
    padding: 10px 20px;
    border-radius: 20px;
    font-weight: 600;
}

.status-dot {
    width: 12px;
    height: 12px;
    border-radius: 50%;
    animation: pulse 2s infinite;
}

.status-dot.online {
    background: var(--success-color);
}

.status-dot.offline {
    background: var(--danger-color);
    animation: none;
}

@keyframes pulse {
    0%, 100% { opacity: 1; }
    50% { opacity: 0.5; }
}

/* Configuration Panel */
.config-panel {
    background: var(--card-bg);
    backdrop-filter: blur(20px);
    padding: 20px;
    border-radius: 15px;
    box-shadow: var(--shadow);
    margin-bottom: 30px;
    border: 1px solid var(--border-color);
}

.config-panel h2 {
    margin-bottom: 15px;
    color: var(--text-primary);
}

.config-form {
    display: grid;
    grid-template-columns: auto 1fr auto;
    gap: 15px;
    align-items: center;
}

.config-form label {
    font-weight: 600;
    color: var(--text-primary);
}

.config-form input,
.config-form select {
    padding: 14px 18px;
    border: 2px solid var(--border-color);
    border-radius: 12px;
    background: rgba(30, 30, 60, 0.6);
    backdrop-filter: blur(10px);
    color: var(--text-primary);
    font-size: 1em;
    transition: all 0.3s;
}

.config-form input:focus,
.config-form select:focus {
    outline: none;
    border-color: var(--primary-color);
    background: rgba(30, 30, 60, 0.8);
    box-shadow: 0 0 0 3px rgba(102, 126, 234, 0.2);
    transform: translateY(-1px);
}

/* Buttons */
.btn {
    padding: 14px 28px;
    border: none;
    border-radius: 12px;
    font-size: 1em;
    font-weight: 600;
    cursor: pointer;
    transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
    text-transform: uppercase;
    letter-spacing: 1px;
    display: inline-flex;
    align-items: center;
    gap: 10px;
    position: relative;
    overflow: hidden;
    box-shadow: 0 4px 15px rgba(0, 0, 0, 0.2);
}

.btn::before {
    content: '';
    position: absolute;
    top: 50%;
    left: 50%;
    width: 0;
    height: 0;
    border-radius: 50%;
    background: rgba(255, 255, 255, 0.2);
    transform: translate(-50%, -50%);
    transition: width 0.6s, height 0.6s;
}

.btn:hover::before {
    width: 300px;
    height: 300px;
}

.btn-primary {
    background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
    color: white;
}

.btn-primary:hover {
    transform: translateY(-2px);
    box-shadow: 0 8px 25px rgba(102, 126, 234, 0.5);
}

.btn-success {
    background: linear-gradient(135deg, #48bb78 0%, #38a169 100%);
    color: white;
}

.btn-success:hover {
    transform: translateY(-2px);
    box-shadow: 0 8px 25px rgba(72, 187, 120, 0.5);
}

.btn-secondary {
    background: linear-gradient(135deg, #a0aec0 0%, #718096 100%);
    color: white;
}

.btn-secondary:hover {
    transform: translateY(-2px);
    box-shadow: 0 8px 25px rgba(160, 174, 192, 0.4);
}

.btn-danger {
    background: linear-gradient(135deg, #fc5c65 0%, #eb3b5a 100%);
    color: white;
}

.btn-danger:hover {
    transform: translateY(-2px);
    box-shadow: 0 8px 25px rgba(252, 92, 101, 0.5);
}

.btn-warning {
    background: linear-gradient(135deg, #f7b731 0%, #e67e22 100%);
    color: white;
}

.btn-warning:hover {
    transform: translateY(-2px);
    box-shadow: 0 8px 25px rgba(243, 156, 18, 0.3);
}

/* Dashboard Grid */
.dashboard-grid {
    display: grid;
    grid-template-columns: repeat(auto-fit, minmax(350px, 1fr));
    gap: 25px;
}

.card {
    background: var(--card-bg);
    backdrop-filter: blur(20px);
    -webkit-backdrop-filter: blur(20px);
    padding: 30px;
    border-radius: 20px;
    box-shadow: var(--shadow);
    border: 1px solid var(--border-color);
    transition: all 0.4s cubic-bezier(0.4, 0, 0.2, 1);
}

.card:hover {
    transform: translateY(-5px) scale(1.01);
    box-shadow: var(--shadow), var(--glow);
    border-color: rgba(102, 126, 234, 0.5);
}

.card h2 {
    color: var(--text-primary);
    margin-bottom: 20px;
    font-size: 1.5em;
    border-bottom: 3px solid var(--primary-color);
    padding-bottom: 10px;
}

.full-width {
    grid-column: 1 / -1;
}

/* Security Status Bar */
.security-status-bar {
    display: flex;
    gap: 20px;
    background: var(--card-bg);
    backdrop-filter: blur(20px);
    padding: 20px;
    border-radius: 20px;
    box-shadow: var(--shadow);
    margin-bottom: 30px;
    flex-wrap: wrap;
    border: 1px solid var(--border-color);
}

.security-status-item {
    display: flex;
    align-items: center;
    gap: 15px;
    flex: 1;
    min-width: 200px;
    padding: 15px;
    background: rgba(102, 126, 234, 0.1);
    border-radius: 10px;
    transition: all 0.3s;
}

.security-status-item:hover {
    transform: scale(1.05);
    box-shadow: 0 4px 15px rgba(102, 126, 234, 0.3);
}

.security-status-item .status-icon {
    font-size: 2.5em;
}

.security-status-item .status-info {
    display: flex;
    flex-direction: column;
}

.security-status-item .status-label {
    font-size: 0.85em;
    color: var(--text-secondary);
    text-transform: uppercase;
    font-weight: 600;
}

.security-status-item .status-value {
    font-size: 1.3em;
    font-weight: bold;
    color: var(--text-primary);
}

/* Camera Section */
.camera-section {
    grid-column: span 2;
}

.camera-container {
    position: relative;
    width: 100%;
    background: #000;
    border-radius: 10px;
    overflow: hidden;
    min-height: 400px;
}

.camera-container img,
.camera-container canvas {
    width: 100%;
    height: auto;
    display: block;
}

#detectionCanvas {
    position: absolute;
    top: 0;
    left: 0;
}

.camera-overlay {
    position: absolute;
    top: 0;
    left: 0;
    right: 0;
    bottom: 0;
    background: rgba(0, 0, 0, 0.7);
    display: flex;
    flex-direction: column;
    align-items: center;
    justify-content: center;
    color: white;
    font-size: 1.2em;
}

.overlay-hint {
    font-size: 0.9em;
    color: #aaa;
    margin-top: 10px;
}

.camera-controls {
    display: flex;
    gap: 10px;
    margin-top: 15px;
    flex-wrap: wrap;
}

.camera-controls button {
    flex: 1;
    min-width: 150px;
}

/* Alert Settings */
.alert-settings {
    margin: 15px 0;
    padding: 15px;
    background: rgba(52, 73, 94, 0.3);
    border-radius: 10px;
    border: 1px solid rgba(52, 152, 219, 0.2);
}

.alert-objects {
    display: grid;
    grid-template-columns: repeat(2, 1fr);
    gap: 8px;
}

.object-checkbox {
    display: flex;
    align-items: center;
    gap: 10px;
    padding: 12px 16px;
    background: rgba(102, 126, 234, 0.1);
    border: 2px solid rgba(102, 126, 234, 0.2);
    border-radius: 12px;
    cursor: pointer;
    transition: all 0.3s ease;
    font-size: 0.95em;
    backdrop-filter: blur(5px);
}

.object-checkbox:hover {
    background: rgba(102, 126, 234, 0.2);
    border-color: rgba(102, 126, 234, 0.6);
    transform: translateX(5px);
    box-shadow: 0 4px 12px rgba(102, 126, 234, 0.3);
}

.object-checkbox input[type="checkbox"] {
    cursor: pointer;
    margin: 0;
}

.object-checkbox input[type="checkbox"]:checked + span {
    color: #667eea;
    font-weight: 700;
    text-shadow: 0 0 10px rgba(102, 126, 234, 0.5);
}

/* Detection Stats */
.detection-stats {
    display: flex;
    justify-content: space-around;
    gap: 15px;
    margin-top: 15px;
    padding: 15px;
    background: rgba(102, 126, 234, 0.1);
    border-radius: 10px;
    flex-wrap: wrap;
}

.stat-item {
    text-align: center;
}

.stat-item .stat-label {
    font-size: 0.85em;
    color: var(--text-secondary);
    font-weight: 600;
    display: block;
    margin-bottom: 5px;
}

.stat-item .stat-value {
    font-size: 1.2em;
    font-weight: bold;
    color: var(--text-primary);
}

/* Alert Banner */
.alert-banner {
    position: fixed;
    top: 20px;
    left: 50%;
    transform: translateX(-50%);
    z-index: 10000;
    animation: slideDown 0.3s ease-out;
}

@keyframes slideDown {
    from {
        top: -100px;
        opacity: 0;
    }
    to {
        top: 20px;
        opacity: 1;
    }
}

.alert-content {
    background: linear-gradient(135deg, #fc5c65 0%, #eb3b5a 100%);
    color: white;
    padding: 25px 35px;
    border-radius: 16px;
    box-shadow: 0 10px 40px rgba(252, 92, 101, 0.6);
    display: flex;
    align-items: center;
    gap: 18px;
    min-width: 450px;
    border: 2px solid rgba(255, 255, 255, 0.4);
    animation: pulse-alert 2s infinite;
    backdrop-filter: blur(10px);
}

@keyframes pulse-alert {
    0%, 100% {
        box-shadow: 0 8px 32px rgba(231, 76, 60, 0.4);
    }
    50% {
        box-shadow: 0 8px 48px rgba(231, 76, 60, 0.8);
    }
}

.alert-icon {
    font-size: 2em;
    animation: shake 0.5s infinite;
}

@keyframes shake {
    0%, 100% { transform: rotate(0deg); }
    25% { transform: rotate(-10deg); }
    75% { transform: rotate(10deg); }
}

.alert-text {
    flex: 1;
    font-size: 1.1em;
    font-weight: bold;
    text-shadow: 0 2px 4px rgba(0, 0, 0, 0.3);
}

.alert-close {
    background: rgba(255, 255, 255, 0.2);
    border: none;
    color: white;
    width: 30px;
    height: 30px;
    border-radius: 50%;
    cursor: pointer;
    font-size: 1.2em;
    display: flex;
    align-items: center;
    justify-content: center;
    transition: all 0.3s;
}

.alert-close:hover {
    background: rgba(255, 255, 255, 0.4);
    transform: rotate(90deg);
}

/* Events Log */
.events-log {
    background: #1e1e1e;
    color: #00ff00;
    padding: 20px;
    border-radius: 10px;
    font-family: 'Courier New', monospace;
    font-size: 0.9em;
    height: 350px;
    overflow-y: auto;
    margin-bottom: 15px;
}

.events-log .log-entry {
    margin: 8px 0;
    padding: 8px;
    border-left: 3px solid transparent;
    transition: all 0.3s;
}

.events-log .log-entry.info {
    color: #4dabf7;
    border-left-color: #4dabf7;
}

.events-log .log-entry.success {
    color: #2ecc71;
    border-left-color: #2ecc71;
}

.events-log .log-entry.warning {
    color: #ffa500;
    border-left-color: #ffa500;
    background: rgba(255, 165, 0, 0.1);
}

.events-log .log-entry.error,
.events-log .log-entry.alarm {
    color: #ff6b6b;
    border-left-color: #ff6b6b;
    background: rgba(255, 107, 107, 0.2);
    font-weight: bold;
    animation: logPulse 1s ease-in-out;
}

@keyframes logPulse {
    0%, 100% { opacity: 1; }
    50% { opacity: 0.7; }
}

/* Scrollbar */
.events-log::-webkit-scrollbar {
    width: 8px;
}

.events-log::-webkit-scrollbar-track {
    background: #2c2c2c;
    border-radius: 10px;
}

.events-log::-webkit-scrollbar-thumb {
    background: #555;
    border-radius: 10px;
}

.events-log::-webkit-scrollbar-thumb:hover {
    background: #777;
}

/* Sensor Grid */
.sensor-grid {
    display: grid;
    gap: 15px;
}

.sensor-item {
    display: flex;
    flex-direction: column;
    gap: 5px;
    padding: 15px;
    background: rgba(102, 126, 234, 0.1);
    border-radius: 10px;
    transition: background 0.3s;
}

.sensor-item:hover {
    background: rgba(102, 126, 234, 0.2);
}

.sensor-label {
    font-weight: 600;
    color: var(--text-secondary);
    font-size: 0.9em;
    text-transform: uppercase;
}

.sensor-value {
    font-size: 1.8em;
    font-weight: bold;
    color: var(--text-primary);
}

/* Snapshots Container */
.snapshots-container {
    display: grid;
    grid-template-columns: repeat(auto-fill, minmax(200px, 1fr));
    gap: 15px;
    min-height: 150px;
}

.snapshot-item {
    position: relative;
    border-radius: 10px;
    overflow: hidden;
    box-shadow: 0 4px 10px rgba(0, 0, 0, 0.3);
    transition: transform 0.3s;
}

.snapshot-item:hover {
    transform: scale(1.05);
}

.snapshot-item img {
    width: 100%;
    height: 200px;
    object-fit: cover;
    display: block;
}

.snapshot-info {
    position: absolute;
    bottom: 0;
    left: 0;
    right: 0;
    background: rgba(0, 0, 0, 0.8);
    color: white;
    padding: 10px;
    display: flex;
    justify-content: space-between;
    align-items: center;
}

.snapshot-time {
    font-size: 0.75em;
}

.btn-small {
    padding: 5px 10px;
    font-size: 0.75em;
    background: var(--primary-color);
    color: white;
    border: none;
    border-radius: 5px;
    cursor: pointer;
}

.btn-small:hover {
    background: var(--primary-light);
}

.placeholder-text {
    grid-column: 1 / -1;
    text-align: center;
    color: var(--text-secondary);
    padding: 40px;
    font-size: 1.1em;
}

/* Info Grid */
.info-grid {
    display: grid;
    gap: 10px;
}

.info-item {
    display: flex;
    justify-content: space-between;
    padding: 10px;
    background: rgba(102, 126, 234, 0.1);
    border-radius: 8px;
}

.info-label {
    font-weight: 600;
    color: var(--text-secondary);
}

.info-value {
    font-weight: bold;
    color: var(--text-primary);
}

/* Updated values animation */
.updated {
    animation: highlight 0.3s ease;
}

@keyframes highlight {
    0%, 100% {
        background: transparent;
    }
    50% {
        background: rgba(39, 174, 96, 0.2);
    }
}

/* Responsive Design */
@media (max-width: 768px) {
    .config-form {
        grid-template-columns: 1fr;
    }
    
    .dashboard-grid {
        grid-template-columns: 1fr;
    }
    
    .camera-section {
        grid-column: span 1;
    }
    
    header h1 {
        font-size: 2em;
    }
    
    .security-status-bar {
        flex-direction: column;
    }
    
    .detection-stats,
    .alert-objects {
        flex-direction: column;
    }
    
    .camera-controls {
        flex-direction: column;
    }
    
    .alert-content {
        min-width: 300px;
        padding: 20px;
    }
}
    </style>
</head>
<body>
    <div class="container">
        <!-- Header -->
        <header>
            <h1>üîí ESP32-CAM Security System</h1>
            <p class="subtitle">AI-Powered Human Detection & Alarm System</p>
            <div class="connection-status" id="connectionStatus">
                <span id="statusDot" class="status-dot offline"></span>
                <span id="statusText">Disconnected</span>
            </div>
        </header>

        <!-- Security Status Bar -->
        <section class="security-status-bar" id="securityStatusBar">
            <div class="security-status-item">
                <span class="status-icon">üö®</span>
                <div class="status-info">
                    <span class="status-label">Alarm Status</span>
                    <span class="status-value" id="alarmStatus">DISARMED</span>
                </div>
            </div>
            <div class="security-status-item">
                <span class="status-icon">üë§</span>
                <div class="status-info">
                    <span class="status-label">Detection</span>
                    <span class="status-value" id="detectionStatus">Monitoring...</span>
                </div>
            </div>
            <div class="security-status-item">
                <span class="status-icon">‚ö°</span>
                <div class="status-info">
                    <span class="status-label">Events Today</span>
                    <span class="status-value" id="eventsCount">0</span>
                </div>
            </div>
        </section>

        <!-- Alert Banner -->
        <div class="alert-banner" id="alertBanner" style="display: none;">
            <div class="alert-content">
                <span class="alert-icon">‚ö†Ô∏è</span>
                <span class="alert-text" id="alertText"></span>
                <button class="alert-close" onclick="closeAlertBanner()">‚úï</button>
            </div>
        </div>

        <!-- Configuration Panel -->
        <section class="config-panel">
            <h2>‚öôÔ∏è System Configuration</h2>
            <div class="config-form">
                <label for="cameraIP">ESP32-CAM IP Address:</label>
                <input type="text" id="cameraIP" placeholder="192.168.1.45" value="192.168.1.45">
                <button id="connectCamBtn" class="btn btn-success">Connect Camera</button>
                
                <label for="detectionSensitivity">Detection Sensitivity:</label>
                <select id="detectionSensitivity">
                    <option value="0.5">High (50%)</option>
                    <option value="0.6" selected>Medium (60%)</option>
                    <option value="0.7">Low (70%)</option>
                </select>
            </div>
        </section>

        <!-- Main Dashboard Grid -->
        <div class="dashboard-grid">
            <!-- Camera Feed Section -->
            <section class="card camera-section">
                <h2>üìπ Live Security Feed</h2>
                <div class="camera-container">
                    <canvas id="detectionCanvas" style="display:none;"></canvas>
                    <img id="cameraFeed" alt="Camera feed" style="width:100%; display:block;">
                    <div class="camera-overlay" id="cameraOverlay">
                        <p>Camera not connected</p>
                        <p class="overlay-hint">Enter IP and click Connect Camera</p>
                    </div>
                </div>
                <div class="camera-controls">
                    <button id="streamBtn" class="btn btn-primary">‚ñ∂Ô∏è Start Stream</button>
                    <button id="captureBtn" class="btn btn-secondary">üì∑ Capture</button>
                    <button id="toggleDetectionBtn" class="btn btn-success">ü§ñ Enable AI Detection</button>
                    <button id="toggleAlarmBtn" class="btn btn-danger">üö® Arm Alarm</button>
                </div>
                
                <div class="alert-settings">
                    <h3 style="margin: 15px 0 10px 0; font-size: 1em; color: #ecf0f1;">‚ö†Ô∏è Alert Triggers</h3>
                    <p style="margin: 0 0 10px 0; font-size: 0.85em; color: #95a5a6;">Select objects that will trigger the alarm:</p>
                    <div class="alert-objects">
                        <label class="object-checkbox">
                            <input type="checkbox" value="person" checked>
                            <span>üë§ Person</span>
                        </label>
                        <label class="object-checkbox">
                            <input type="checkbox" value="dog">
                            <span>üêï Dog</span>
                        </label>
                        <label class="object-checkbox">
                            <input type="checkbox" value="cat">
                            <span>üêà Cat</span>
                        </label>
                        <label class="object-checkbox">
                            <input type="checkbox" value="car">
                            <span>üöó Car</span>
                        </label>
                        <label class="object-checkbox">
                            <input type="checkbox" value="truck">
                            <span>üöö Truck</span>
                        </label>
                        <label class="object-checkbox">
                            <input type="checkbox" value="bicycle">
                            <span>üö≤ Bicycle</span>
                        </label>
                        <label class="object-checkbox">
                            <input type="checkbox" value="motorcycle">
                            <span>üèçÔ∏è Motorcycle</span>
                        </label>
                        <label class="object-checkbox">
                            <input type="checkbox" value="backpack">
                            <span>üéí Backpack</span>
                        </label>
                        <label class="object-checkbox">
                            <input type="checkbox" value="cell phone">
                            <span>üì± Phone</span>
                        </label>
                        <label class="object-checkbox">
                            <input type="checkbox" value="laptop">
                            <span>üíª Laptop</span>
                        </label>
                        <label class="object-checkbox">
                            <input type="checkbox" value="tv">
                            <span>üì∫ TV</span>
                        </label>
                    </div>
                </div>
                
                <div class="detection-stats">
                    <div class="stat-item">
                        <span class="stat-label">FPS:</span>
                        <span class="stat-value" id="fpsDisplay">0</span>
                    </div>
                    <div class="stat-item">
                        <span class="stat-label">AI Status:</span>
                        <span class="stat-value" id="aiStatus">Loading...</span>
                    </div>
                    <div class="stat-item">
                        <span class="stat-label">Detected:</span>
                        <span class="stat-value" id="detectedObjects">None</span>
                    </div>
                </div>
            </section>

            <!-- Security Events Log -->
            <section class="card">
                <h2>üìã Security Events Log</h2>
                <div class="events-log" id="eventsLog">
                    <p class="log-entry info">System initialized. Waiting for events...</p>
                </div>
                <button id="clearEventsBtn" class="btn btn-secondary">Clear Events</button>
            </section>

            <!-- Detection History -->
            <section class="card">
                <h2>üìä Detection Statistics</h2>
                <div class="sensor-grid">
                    <div class="sensor-item">
                        <span class="sensor-label">Total Detections</span>
                        <span class="sensor-value" id="totalDetections">0</span>
                    </div>
                    <div class="sensor-item">
                        <span class="sensor-label">Last Detection</span>
                        <span class="sensor-value" id="lastDetection">Never</span>
                    </div>
                    <div class="sensor-item">
                        <span class="sensor-label">Alarm Triggers</span>
                        <span class="sensor-value" id="alarmTriggers">0</span>
                    </div>
                    <div class="sensor-item">
                        <span class="sensor-label">System Uptime</span>
                        <span class="sensor-value" id="systemUptime">0s</span>
                    </div>
                </div>
            </section>

            <!-- Captured Snapshots -->
            <section class="card full-width">
                <h2>üì∏ Captured Snapshots</h2>
                <div class="snapshots-container" id="snapshotsContainer">
                    <p class="placeholder-text">No snapshots yet. Snapshots are automatically captured when humans are detected.</p>
                </div>
            </section>

            <!-- System Info Section -->
            <section class="card">
                <h2>üìä System Information</h2>
                <div class="info-grid">
                    <div class="info-item">
                        <span class="info-label">Camera Status:</span>
                        <span class="info-value" id="cameraStatus">Disconnected</span>
                    </div>
                    <div class="info-item">
                        <span class="info-label">AI Model:</span>
                        <span class="info-value" id="aiModelStatus">Loading...</span>
                    </div>
                    <div class="info-item">
                        <span class="info-label">Last Update:</span>
                        <span class="info-value" id="lastUpdate">Never</span>
                    </div>
                </div>
            </section>
        </div>

        <!-- Alarm Sound (Hidden) -->
        <audio id="alarmSound" loop>
            <source src="data:audio/wav;base64,UklGRnoGAABXQVZFZm10IBAAAAABAAEAQB8AAEAfAAABAAgAZGF0YQoGAACBhYqFbF1fdJivrJBhNjVgodDbq2EcBj+a2/LDciUFLIHO8tiJNwgZaLvt559NEAxQp+PwtmMcBjiR1/LMeSwFJHfH8N2QQAoUXrTp66hVFApGn+DyvmwhBSuBzvLZiTYIGGe76+eeUwwMUKbu8bRlGggzk9jyz3orBSV+yO/ekk0IEVms6OyrWA8LR6Pg8blkGgY+mdzvyHUpBSB5xu7dlEcIDlOo5O63YRoHNo7W8s92LgUldMXu3JFBCBJaquXurWEUCzye0/HJeSsFInTF8NuRSAcNV6rm8bJhFwo4mtjxzHgpBR92xO7Yk0cIDFOs5e23YRoGNJHX8styLAUndsTu25BHCAhWqOTtsmEaCzSP1vLMeSoFJXPD79yQRwgMV6vk7bNeFws0kdvwynkpBR92yO/bkUgHDViu5e+0YRUKNJXb8s96KAUieMnv25JJBgtYruTvtmEUCTCR2u/MdysEInLG8NySRwYNWbDk77ZeFQozjdXzzHgqBCJ0xe/ckEYHC1is5PG4YBQJMpLZ8M14KAQgdMnv3JFGBw1ZsuTvumAUCjGO1vDNdysEIHLH8NyRRwcLWK7j8bliEwkyj9nwzXYpBCFzyO7bk0cGDVmw5PC2YBQJMo3W8ct3KgUkdcnu3JJHCA1YruPxtmETCTGO2PDLdysEInLG8NySRwcMWK7k8LhgFAkyj9nwy3YpBSF0yO7ck0gGDVmu4/C2YRMIMpHY8Mt2KgQhc8bv3JJHBwtXruTvuGATCDGQ2fDKdikEInLG79yRSAYNWK7k77VhEwkxj9nwy3UqBCJzxu/ckUcHDFiv5PC4YRMJMI/Z8Mp2KQUgc8jv25FHBw1YruTvuGATCDKP2fDLdioEIHPG79uSRwcMV67k8LdgFAkxj9nwyn0pBSBzxu/bkkgGDlmu5O+2YRMJMpDY8Mp2KQQhc8Xv25FHBw1ZruTvuGATCDCO2PDKdSoFInLG8NuRSAYNWa7k77ZgEwkxj9nwynUpBCJzxu/bkkgGDVmu5PG4YBMJMY/Y8Mt1KgQhc8bu25FHBw1YruTvt2ATCTGMgAA" type="audio/wav">
        </audio>
    </div>

    <script>
// ESP32-CAM Security System - AI Human Detection Dashboard

// Global variables
let esp32IP = '';
let isStreaming = false;
let detectionEnabled = false;
let alarmArmed = false;
let cocoSsdModel = null;
let alertTriggerObjects = new Set(['person']); // Objects that trigger alarm
let alertBannerTimeout = null;
let audioContext = null;
let sirenOscillator = null;
let sirenGain = null;
let detectionInterval = null;
let startTime = Date.now();
let totalDetections = 0;
let alarmTriggers = 0;
let lastDetectionTime = null;
let fpsCounter = 0;
let fpsStartTime = Date.now();
let snapshots = [];

// Canvas and Image elements
let canvas, ctx, img;

// Detection sensitivity threshold (0.0 to 1.0)
let detectionThreshold = 0.6;

// Initialize when page loads
document.addEventListener('DOMContentLoaded', function() {
    console.log('Security System Dashboard Initialized');
    initializeElements();
    initializeEventListeners();
    loadAIModel();
    updateSystemInfo();
    setInterval(updateSystemInfo, 1000);
    setInterval(updateFPS, 1000);
});

// Initialize canvas and image elements
function initializeElements() {
    canvas = document.getElementById('detectionCanvas');
    ctx = canvas.getContext('2d');
    img = document.getElementById('cameraFeed');
    
    // CRITICAL: Enable CORS for cross-origin images
    img.crossOrigin = "anonymous";
    
    // Set canvas size
    canvas.width = 640;
    canvas.height = 480;
}

// Initialize event listeners
function initializeEventListeners() {
    document.getElementById('connectCamBtn').addEventListener('click', connectCamera);
    document.getElementById('streamBtn').addEventListener('click', toggleStream);
    document.getElementById('captureBtn').addEventListener('click', captureImage);
    document.getElementById('toggleDetectionBtn').addEventListener('click', toggleDetection);
    document.getElementById('toggleAlarmBtn').addEventListener('click', toggleAlarm);    
    // Add event listeners for alert checkboxes
    const checkboxes = document.querySelectorAll('.object-checkbox input[type="checkbox"]');
    checkboxes.forEach(checkbox => {
        checkbox.addEventListener('change', updateAlertTriggers);
    });
    updateAlertTriggers();    
    document.getElementById('clearEventsBtn').addEventListener('click', clearEvents);
    document.getElementById('detectionSensitivity').addEventListener('change', updateSensitivity);
}

// Speak alert using text-to-speech
function speakAlert(objectName) {
    try {
        window.speechSynthesis.cancel();
        const utterance = new SpeechSynthesisUtterance();
        utterance.text = `Alert! ${objectName} detected in room!`;
        utterance.rate = 1.1;
        utterance.pitch = 1.0;
        utterance.volume = 1.0;
        window.speechSynthesis.speak(utterance);
    } catch (e) {
        console.log('Speech synthesis not supported:', e);
    }
}

// Stop speech
function stopSpeech() {
    try {
        window.speechSynthesis.cancel();
    } catch (e) {}
}

// Load TensorFlow.js COCO-SSD model for object detection
async function loadAIModel() {
    try {
        addEvent('Loading AI detection model...', 'info');
        document.getElementById('aiStatus').textContent = 'Loading...';
        document.getElementById('aiModelStatus').textContent = 'Loading...';
        
        cocoSsdModel = await cocoSsd.load();
        
        addEvent('‚úì AI Model loaded successfully! Ready for human detection.', 'success');
        document.getElementById('aiStatus').textContent = 'Ready';
        document.getElementById('aiModelStatus').textContent = 'COCO-SSD Ready';
        console.log('COCO-SSD model loaded');
    } catch (error) {
        addEvent('Failed to load AI model: ' + error.message, 'error');
        document.getElementById('aiStatus').textContent = 'Error';
        document.getElementById('aiModelStatus').textContent = 'Failed';
        console.error('Model loading error:', error);
    }
}

// Show alert banner
function showAlertBanner(objectName) {
    const banner = document.getElementById('alertBanner');
    const alertText = document.getElementById('alertText');
    
    const emoji = getObjectEmoji(objectName);
    alertText.textContent = `${emoji} ${objectName.toUpperCase()} DETECTED IN ROOM!`;
    
    if (banner.style.display !== 'block') {
        banner.style.display = 'block';
        speakAlert(objectName);
    }
    
    if (alertBannerTimeout) {
        clearTimeout(alertBannerTimeout);
    }
    
    alertBannerTimeout = setTimeout(() => {
        closeAlertBanner();
    }, 10000);
}

// Close alert banner
function closeAlertBanner() {
    const banner = document.getElementById('alertBanner');
    banner.style.display = 'none';
    stopSpeech();
    if (alertBannerTimeout) {
        clearTimeout(alertBannerTimeout);
        alertBannerTimeout = null;
    }
}

// Get emoji for object
function getObjectEmoji(objectName) {
    const emojiMap = {
        'person': 'üë§', 'dog': 'üêï', 'cat': 'üêà', 'car': 'üöó',
        'truck': 'üöö', 'bicycle': 'üö≤', 'motorcycle': 'üèçÔ∏è', 'backpack': 'üéí',
        'cell phone': 'üì±', 'laptop': 'üíª', 'tv': 'üì∫'
    };
    return emojiMap[objectName] || '‚ö†Ô∏è';
}

// Update alert trigger objects
function updateAlertTriggers() {
    const checkboxes = document.querySelectorAll('.object-checkbox input[type="checkbox"]');
    alertTriggerObjects.clear();
    checkboxes.forEach(checkbox => {
        if (checkbox.checked) {
            alertTriggerObjects.add(checkbox.value);
        }
    });
    const triggers = Array.from(alertTriggerObjects).join(', ');
    addEvent(`Alert triggers updated: ${triggers || 'None'}`, 'info');
}

// Connect to ESP32-CAM
function connectCamera() {
    esp32IP = document.getElementById('cameraIP').value.trim();
    if (!esp32IP) {
        alert('Please enter ESP32-CAM IP address');
        return;
    }
    addEvent('Camera set to ' + esp32IP + ' - Click Start Stream to begin', 'success');
    document.getElementById('cameraStatus').textContent = 'Ready';
    document.getElementById('cameraOverlay').style.display = 'none';
    updateConnectionStatus(true);
}

// Toggle video stream
function toggleStream() {
    if (!esp32IP) {
        alert('Please connect to camera first');
        return;
    }
    
    isStreaming = !isStreaming;
    const btn = document.getElementById('streamBtn');
    
    if (isStreaming) {
        const streamUrl = `http://${esp32IP}/stream?t=${Date.now()}`;
        img.src = streamUrl;
        
        img.onload = function() {
            addEvent('üìπ Stream connected successfully', 'success');
        };
        
        img.onerror = function() {
            addEvent('‚ùå Stream failed. Check: 1) ESP32 IP correct 2) Same network', 'error');
            isStreaming = false;
            btn.textContent = '‚ñ∂Ô∏è Start Stream';
            btn.classList.remove('btn-danger');
            btn.classList.add('btn-primary');
        };
        
        btn.textContent = '‚è∏ Stop Stream';
        btn.classList.add('btn-danger');
        btn.classList.remove('btn-primary');
        addEvent('üìπ Streaming started from ' + streamUrl, 'info');
        
        if (detectionEnabled && cocoSsdModel) {
            startDetection();
        }
    } else {
        img.src = '';
        img.onload = null;
        img.onerror = null;
        btn.textContent = '‚ñ∂Ô∏è Start Stream';
        btn.classList.remove('btn-danger');
        btn.classList.add('btn-primary');
        addEvent('‚è∏ Streaming stopped', 'info');
        stopDetection();
    }
}

// Capture single image
function captureImage() {
    if (!esp32IP) {
        alert('Please connect to camera first');
        return;
    }
    const timestamp = Date.now();
    img.src = `http://${esp32IP}/capture?t=${timestamp}`;
    addEvent('üì∑ Image captured', 'info');
}

// Toggle AI detection
function toggleDetection() {
    if (!cocoSsdModel) {
        alert('AI model not loaded yet. Please wait...');
        return;
    }
    
    if (!isStreaming) {
        alert('Please start stream first');
        return;
    }
    
    detectionEnabled = !detectionEnabled;
    const btn = document.getElementById('toggleDetectionBtn');
    
    if (detectionEnabled) {
        btn.textContent = 'ü§ñ Disable AI Detection';
        btn.classList.add('btn-danger');
        btn.classList.remove('btn-success');
        addEvent('ü§ñ AI Detection enabled', 'success');
        startDetection();
    } else {
        btn.textContent = 'ü§ñ Enable AI Detection';
        btn.classList.remove('btn-danger');
        btn.classList.add('btn-success');
        addEvent('ü§ñ AI Detection disabled', 'info');
        stopDetection();
    }
}

// Start detection loop
function startDetection() {
    if (detectionInterval) return;
    detectionInterval = setInterval(async () => {
        if (!isStreaming || !detectionEnabled) {
            stopDetection();
            return;
        }
        await detectObjects();
    }, 500);
}

// Stop detection loop
function stopDetection() {
    if (detectionInterval) {
        clearInterval(detectionInterval);
        detectionInterval = null;
    }
    canvas.style.display = 'none';
    img.style.display = 'block';
    ctx.clearRect(0, 0, canvas.width, canvas.height);
}

// Detect objects using TensorFlow.js COCO-SSD
async function detectObjects() {
    try {
        if (!img.complete || img.naturalWidth === 0) {
            return;
        }
        
        if (canvas.style.display === 'none') {
            canvas.width = img.naturalWidth;
            canvas.height = img.naturalHeight;
            canvas.style.display = 'block';
            canvas.style.position = 'absolute';
            canvas.style.top = '0';
            canvas.style.left = '0';
            img.style.display = 'none';
        }
        
        ctx.drawImage(img, 0, 0, canvas.width, canvas.height);
        const predictions = await cocoSsdModel.detect(canvas);
        const humans = predictions.filter(pred => pred.class === 'person' && pred.score >= detectionThreshold);
        
        drawPredictions(predictions);
        
        let detectedObjects = predictions.map(p => p.class).join(', ') || 'None';
        document.getElementById('detectedObjects').textContent = detectedObjects;
        
        const detectedTriggers = predictions.filter(p => alertTriggerObjects.has(p.class));
        
        if (detectedTriggers.length > 0) {
            const uniqueTriggers = [...new Set(detectedTriggers.map(p => p.class))];
            uniqueTriggers.forEach(objectName => {
                showAlertBanner(objectName);
                addEvent(`üö® ALERT! ${objectName.toUpperCase()} detected!`, 'error');
            });
            captureSnapshot();
            if (alarmArmed) {
                triggerAlarm(detectedTriggers.length);
            }
        }
        
        if (humans.length > 0) {
            handleHumanDetection(humans);
        }
        
        fpsCounter++;
    } catch (error) {
        console.error('Detection error:', error);
    }
}

// Draw prediction bounding boxes on canvas
function drawPredictions(predictions) {
    predictions.forEach(pred => {
        const [x, y, width, height] = pred.bbox;
        const isHuman = pred.class === 'person';
        ctx.strokeStyle = isHuman ? '#ff0000' : '#00ff00';
        ctx.lineWidth = isHuman ? 4 : 2;
        ctx.strokeRect(x, y, width, height);
        ctx.fillStyle = isHuman ? '#ff0000' : '#00ff00';
        const label = `${pred.class} ${Math.round(pred.score * 100)}%`;
        const textWidth = ctx.measureText(label).width;
        ctx.fillRect(x, y - 25, textWidth + 10, 25);
        ctx.fillStyle = '#ffffff';
        ctx.font = '16px Arial';
        ctx.fillText(label, x + 5, y - 7);
    });
}

// Handle human detection event
function handleHumanDetection(humans) {
    const now = Date.now();
    if (lastDetectionTime && (now - lastDetectionTime) < 2000) {
        return;
    }
    lastDetectionTime = now;
    totalDetections++;
    
    const humanCount = humans.length;
    const confidences = humans.map(h => Math.round(h.score * 100));
    addEvent(`üë§ HUMAN DETECTED! Count: ${humanCount}, Confidence: ${confidences.join(', ')}%`, 'warning');
    
    document.getElementById('totalDetections').textContent = totalDetections;
    document.getElementById('lastDetection').textContent = new Date().toLocaleTimeString();
    document.getElementById('eventsCount').textContent = totalDetections;
    document.getElementById('detectionStatus').textContent = `${humanCount} Human(s)`;
    
    captureSnapshot();
    notifyMotionDetection();
    
    if (alarmArmed) {
        triggerAlarm(humanCount);
    }
}

// Notify ESP32-CAM about motion detection
function notifyMotionDetection() {
    if (!esp32IP) return;
    fetch(`http://${esp32IP}/motion`, {
        method: 'POST',
        mode: 'no-cors',
        headers: { 'Content-Type': 'application/json' }
    })
    .then(() => console.log('Motion notified'))
    .catch(() => {});
}

// Trigger alarm
function triggerAlarm(humanCount) {
    alarmTriggers++;
    document.getElementById('alarmTriggers').textContent = alarmTriggers;
    addEvent(`üö® ALARM TRIGGERED! ${humanCount} human(s) detected!`, 'alarm');
    
    const alarmSound = document.getElementById('alarmSound');
    alarmSound.play().catch(e => console.log('Audio play prevented'));
    flashAlarmStatus();
    
    setTimeout(() => {
        alarmSound.pause();
        alarmSound.currentTime = 0;
    }, 10000);
}

// Flash alarm status indicator
function flashAlarmStatus() {
    const statusBar = document.getElementById('securityStatusBar');
    let flashCount = 0;
    const flashInterval = setInterval(() => {
        statusBar.style.background = flashCount % 2 === 0 ? '#e74c3c' : '';
        flashCount++;
        if (flashCount > 10) {
            clearInterval(flashInterval);
            statusBar.style.background = '';
        }
    }, 300);
}

// Capture snapshot
function captureSnapshot() {
    const dataUrl = canvas.toDataURL('image/jpeg', 0.8);
    const timestamp = new Date().toLocaleString();
    snapshots.unshift({ dataUrl, timestamp });
    if (snapshots.length > 10) {
        snapshots = snapshots.slice(0, 10);
    }
    displaySnapshots();
}

// Display snapshots in UI
function displaySnapshots() {
    const container = document.getElementById('snapshotsContainer');
    if (snapshots.length === 0) {
        container.innerHTML = '<p class="placeholder-text">No snapshots yet. Snapshots are automatically captured when humans are detected.</p>';
        return;
    }
    container.innerHTML = snapshots.map((snap, index) => `
        <div class="snapshot-item">
            <img src="${snap.dataUrl}" alt="Snapshot ${index + 1}">
            <div class="snapshot-info">
                <span class="snapshot-time">${snap.timestamp}</span>
                <button onclick="downloadSnapshot(${index})" class="btn-small">Download</button>
            </div>
        </div>
    `).join('');
}

// Download snapshot
function downloadSnapshot(index) {
    const snap = snapshots[index];
    const link = document.createElement('a');
    link.href = snap.dataUrl;
    link.download = `security_snapshot_${snap.timestamp.replace(/[/:, ]/g, '_')}.jpg`;
    link.click();
}

// Toggle alarm armed state
function toggleAlarm() {
    if (!esp32IP) {
        alert('Please connect to camera first');
        return;
    }
    fetch(`http://${esp32IP}/alarm/toggle`)
        .then(response => response.json())
        .then(data => {
            alarmArmed = data.armed;
            updateAlarmUI();
            addEvent(alarmArmed ? 'üîí ALARM ARMED' : 'üîì ALARM DISARMED', alarmArmed ? 'warning' : 'info');
        })
        .catch(error => {
            addEvent('Failed to toggle alarm: ' + error.message, 'error');
        });
}

// Update alarm UI
function updateAlarmUI() {
    const btn = document.getElementById('toggleAlarmBtn');
    const statusValue = document.getElementById('alarmStatus');
    
    if (alarmArmed) {
        btn.textContent = 'üîì Disarm Alarm';
        btn.classList.remove('btn-danger');
        btn.classList.add('btn-warning');
        statusValue.textContent = 'ARMED';
        statusValue.style.color = '#e74c3c';
    } else {
        btn.textContent = 'üö® Arm Alarm';
        btn.classList.add('btn-danger');
        btn.classList.remove('btn-warning');
        statusValue.textContent = 'DISARMED';
        statusValue.style.color = '#95a5a6';
    }
}

// Update detection sensitivity
function updateSensitivity() {
    detectionThreshold = parseFloat(document.getElementById('detectionSensitivity').value);
    addEvent(`Detection sensitivity updated to ${Math.round((1 - detectionThreshold) * 100)}%`, 'info');
}

// Update FPS display
function updateFPS() {
    const elapsed = (Date.now() - fpsStartTime) / 1000;
    const fps = elapsed > 0 ? Math.round(fpsCounter / elapsed) : 0;
    document.getElementById('fpsDisplay').textContent = fps;
    if (elapsed > 5) {
        fpsCounter = 0;
        fpsStartTime = Date.now();
    }
}

// Update connection status
function updateConnectionStatus(connected) {
    const statusDot = document.getElementById('statusDot');
    const statusText = document.getElementById('statusText');
    if (connected) {
        statusDot.className = 'status-dot online';
        statusText.textContent = 'Connected';
    } else {
        statusDot.className = 'status-dot offline';
        statusText.textContent = 'Disconnected';
    }
}

// Update system information
function updateSystemInfo() {
    const now = new Date();
    document.getElementById('lastUpdate').textContent = now.toLocaleTimeString();
    const uptime = Math.floor((Date.now() - startTime) / 1000);
    document.getElementById('systemUptime').textContent = formatUptime(uptime);
}

// Format uptime
function formatUptime(seconds) {
    const h = Math.floor(seconds / 3600);
    const m = Math.floor((seconds % 3600) / 60);
    const s = seconds % 60;
    return `${h}h ${m}m ${s}s`;
}

// Add event to security log
function addEvent(message, type = 'info') {
    const log = document.getElementById('eventsLog');
    const entry = document.createElement('p');
    entry.className = 'log-entry ' + type;
    const timestamp = new Date().toLocaleTimeString();
    entry.textContent = `[${timestamp}] ${message}`;
    log.insertBefore(entry, log.firstChild);
    if (log.children.length > 50) {
        log.removeChild(log.lastChild);
    }
    console.log(`[${type.toUpperCase()}] ${message}`);
}

// Clear events log
function clearEvents() {
    const log = document.getElementById('eventsLog');
    log.innerHTML = '<p class="log-entry info">Events log cleared</p>';
}
    </script>
</body>
</html>
